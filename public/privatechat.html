<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Private Chat â€¢ Dark Mode</title>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family:sans-serif; background:#121212; color:#eee; height:100vh; display:flex; flex-direction:column; }
    .topbar { background:#1f1f1f; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .topbar h3 { margin:0; }
    .topbar .actions button { background:transparent; border:none; color:#eee; font-size:18px; margin-left:12px; cursor:pointer; }
    #chat-box { flex:1; overflow-y:auto; padding:12px; }
    .message { max-width: 70%; padding:10px; margin-bottom:8px; border-radius:12px; position:relative; }
    .me    { background:#2979ff; align-self:flex-end; }
    .other { background:#333; align-self:flex-start; }
    .reply, .reaction, .timestamp { font-size:12px; color:#bbb; margin-top:4px; }
    .input-area { display:flex; padding:12px; background:#1f1f1f; gap:8px; }
    .input-area input { flex:1; padding:10px; border-radius:20px; border:none; background:#333; color:#eee; }
    .input-area button { background:#2979ff; border:none; padding:10px 16px; border-radius:20px; color:#fff; cursor:pointer; }
    #typing { padding:0 16px; font-size:13px; font-style:italic; color:#aaa; height:18px; }
    .video-call-ui { position:fixed; top:70px; right:20px; width:320px; height:360px; background:#000; display:none; flex-direction:column; border:2px solid #2979ff; border-radius:12px; overflow:hidden; }
    .video-call-ui video { flex:1; width:100%; }
    .call-controls { background:#1f1f1f; padding:8px; display:flex; justify-content:center; gap:12px; }
    .call-controls button { background:#d32f2f; border:none; padding:8px 12px; border-radius:6px; color:#fff; cursor:pointer; }
  </style>
</head>
<body>

  <div class="topbar">
    <h3 id="receiver-name">Loading...</h3>
    <div class="actions">
      <button onclick="startCall()">ðŸ“ž</button>
      <button onclick="endCall()">ðŸ“´</button>
    </div>
  </div>

  <div id="chat-box"></div>
  <div id="typing"></div>

  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off"/>
    <button onclick="sendMsg()">Send</button>
  </div>

  <div class="video-call-ui" id="call-ui">
    <video id="remoteVideo" autoplay></video>
    <div class="call-controls">
      <button onclick="toggleMic()">Mute</button>
      <button onclick="toggleCam()">Cam</button>
      <button onclick="endCall()">End</button>
    </div>
  </div>

  <script>
    const socket = io("https://real-time-chat-1-pa6c.onrender.com");
    const user = JSON.parse(localStorage.getItem("user"));
    const receiverUid = localStorage.getItem("receiverUid");
    const receiver = localStorage.getItem("receiver");
    const sender = user.name;
    const senderUid = user.uid;
    const room = [senderUid, receiverUid].sort().join("_");

    document.getElementById("receiver-name").innerText = receiver;
    socket.emit("set_name", sender);
    socket.emit("join-room", room);

    const chatBox = document.getElementById("chat-box"), msgInput = document.getElementById("msgInput"), typingDiv = document.getElementById("typing");

    socket.on("private-message", ({ sender: s, text }) => addMessage(s, text));
    socket.on("typing", name => { typingDiv.innerText = name + ' is typing...'; setTimeout(() => typingDiv.innerText = '', 2000); });

    window.onload = async () => {
      const res = await fetch(`/get-room-messages?room=${room}`);
      (await res.json()).forEach(m => addMessage(m.sender, m.text));
    }

    msgInput.addEventListener("input", () => socket.emit("typing", sender));

    function sendMsg() {
      const txt = msgInput.value.trim();
      if (!txt) return;
      socket.emit("private-message", { room, sender, text: txt });
      msgInput.value = "";
    }

    function addMessage(senderName, text) {
      const div = document.createElement("div");
      div.classList.add('message', senderName === sender ? 'me' : 'other');
      div.innerHTML = `<b>${senderName}:</b> ${text}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ðŸ’¬ CALL UI STUB
    function startCall() { document.getElementById('call-ui').style.display = 'flex'; /* WebRTC init... */ }
    function endCall()   { document.getElementById('call-ui').style.display = 'none'; /* tearDown... */ }
    function toggleMic() {}
    function toggleCam() {}

  </script>
</body>
</html>
