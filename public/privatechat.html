<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #chat { height: 80vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .msg { margin: 5px 0; }
    .mine { color: blue; }
    .other { color: green; }
    #inputArea { display: flex; margin-top: 10px; }
    #inputArea input { flex: 1; padding: 5px; }
    #inputArea button { padding: 5px 10px; }
  </style>
</head>
<body>
  <h2>Private Chat</h2>
  <div id="chat"></div>
  <div id="inputArea">
    <input id="messageInput" type="text" placeholder="Type message..." />
    <button id="sendBtn">Send</button>
  </div>

  <script>
  // ‚úÖ Get current user from localStorage
  const currentUser = JSON.parse(localStorage.getItem("user"));
  if (!currentUser || !currentUser.uid || !currentUser.name) {
    alert("‚ùå User not logged in. Redirecting...");
    window.location.href = "login.html";
  }

  // ‚úÖ Friend UID from query param (?uid=...)
  const params = new URLSearchParams(window.location.search);
  const friendUid = params.get("uid");

  if (!friendUid) {
    alert("‚ùå Friend UID missing in URL!");
    throw new Error("Friend UID missing");
  }

  // ‚úÖ Generate consistent room id
  const room = [currentUser.uid, friendUid].sort().join("_");

  // ‚úÖ Setup socket
  const socket = io();

  let lastSentMessage = ""; // Duplicate prevention

  // Send name+uid on connect
  socket.on("connect", () => {
    console.log("üîå Connected to server:", socket.id);
    socket.emit("set_name", { uid: currentUser.uid, name: currentUser.name });

    console.log("üìå Joining room:", room);
    socket.emit("join-room", room);

    // Load old messages
    fetch(`/get-room-messages?room=${room}`)
      .then((res) => res.json())
      .then((msgs) => {
        console.log("üìú Old messages loaded:", msgs);
        msgs.forEach((m) => addMessage(m.sender, m.text));
      })
      .catch((err) => console.error("‚ùå Failed to load messages", err));
  });

  socket.on("connect_error", (err) => {
    console.error("‚ùå Socket connect error:", err);
  });

  socket.on("room-joined", (name) => {
    console.log(`üë• ${name} joined the room`);
  });

  // ‚úÖ Only show actual chat messages, ignore WebRTC / system signals
  socket.on("private-message", (data) => {
    if (!data.sender || !data.text) return; // Ignore WebRTC signals

    // Prevent showing duplicate message sent by self
    if (data.sender === currentUser.name && data.text === lastSentMessage) return;

    addMessage(data.sender, data.text);
  });

  socket.on("disconnect", () => {
    console.warn("‚ö†Ô∏è Disconnected from server");
  });

  // ‚úÖ Send message
  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("messageInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    const payload = { room, sender: currentUser.name, text };
    console.log("‚û°Ô∏è Sending private-message:", payload);
    socket.emit("private-message", payload);

    lastSentMessage = text; // Store last sent message
    addMessage(currentUser.name, text, true);
    document.getElementById("messageInput").value = "";
  }

  // ‚úÖ Add message to chat
  function addMessage(sender, text, mine = false) {
    const div = document.createElement("div");
    div.className = "msg " + (mine ? "mine" : "other");
    div.textContent = `${sender}: ${text}`;
    document.getElementById("chat").appendChild(div);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
  }
        </script>
</body>
</html>
