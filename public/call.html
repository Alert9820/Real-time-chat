<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Call</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
  h2 { text-align: center; }
  #friends { display: flex; flex-direction: column; max-width: 400px; margin: auto; }
  .friend { display: flex; justify-content: space-between; padding: 10px; background: #fff; margin: 5px 0; border-radius: 5px; }
  .friend.online { border-left: 5px solid green; }
  .friend.offline { border-left: 5px solid gray; }
  #incoming-call { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; border: 1px solid #ccc; padding: 20px; border-radius: 10px; z-index: 100; }
  #call-controls { margin-top: 20px; text-align: center; }
  button { padding: 5px 10px; margin: 0 5px; }
</style>
</head>
<body>

<h2>Friends List</h2>
<div id="friends"></div>

<div id="incoming-call">
  <p id="incoming-text"></p>
  <button id="accept-call">Accept</button>
  <button id="reject-call">Reject</button>
</div>

<div id="call-controls" style="display:none;">
  <button id="end-call">End Call</button>
  <audio id="remoteAudio" autoplay></audio>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// Replace these with your logged-in user info
const MY_UID = localStorage.getItem("uid") || "123456";
const MY_NAME = localStorage.getItem("name") || "Sunny";

// Register for call
socket.emit("register-call-user", { uid: MY_UID, name: MY_NAME });

// Fetch friends from server
async function fetchFriends() {
  const res = await fetch(`/get-friends?uid=${MY_UID}`);
  const friends = await res.json();
  const container = document.getElementById("friends");
  container.innerHTML = "";
  friends.forEach(f => {
    const div = document.createElement("div");
    div.className = `friend ${f.online ? "online" : "offline"}`;
    div.innerHTML = `<span>${f.name}</span> <button ${!f.online ? "disabled" : ""} data-uid="${f.uid}">Call</button>`;
    container.appendChild(div);
  });
}
fetchFriends();

// Handle call button click
let pc;
let currentCall = null;

document.getElementById("friends").addEventListener("click", async (e) => {
  if (e.target.tagName === "BUTTON") {
    const friendUid = e.target.dataset.uid;
    startCall(friendUid);
  }
});

async function startCall(friendUid) {
  currentCall = friendUid;
  pc = new RTCPeerConnection();

  const localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = (event) => {
    document.getElementById("remoteAudio").srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("webrtc-ice-candidate", { to: friendUid, candidate: event.candidate, from: MY_UID });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  socket.emit("call-request", {
    to: friendUid,
    callerId: MY_UID,
    callerName: MY_NAME
  });

  socket.once("call-accepted", async () => {
    socket.emit("webrtc-offer", { to: friendUid, offer, from: MY_UID });
    document.getElementById("call-controls").style.display = "block";
  });
}

// Incoming call
socket.on("incoming-call", ({ callerId, callerName }) => {
  currentCall = callerId;
  const popup = document.getElementById("incoming-call");
  document.getElementById("incoming-text").textContent = `Incoming call from ${callerName}`;
  popup.style.display = "block";
});

document.getElementById("accept-call").addEventListener("click", async () => {
  document.getElementById("incoming-call").style.display = "none";

  pc = new RTCPeerConnection();
  const localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  pc.ontrack = (event) => {
    document.getElementById("remoteAudio").srcObject = event.streams[0];
  };

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      socket.emit("webrtc-ice-candidate", { to: currentCall, candidate: event.candidate, from: MY_UID });
    }
  };

  socket.emit("call-accepted", { to: currentCall, callerId: MY_UID });
  document.getElementById("call-controls").style.display = "block";
});

document.getElementById("reject-call").addEventListener("click", () => {
  document.getElementById("incoming-call").style.display = "none";
  socket.emit("call-rejected", { to: currentCall, callerId: MY_UID });
});

// Receive WebRTC offer
socket.on("webrtc-offer", async ({ offer, from }) => {
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit("webrtc-answer", { to: from, answer, from: MY_UID });
});

// Receive WebRTC answer
socket.on("webrtc-answer", async ({ answer }) => {
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
});

// ICE candidates
socket.on("webrtc-ice-candidate", ({ candidate }) => {
  if (pc) pc.addIceCandidate(new RTCIceCandidate(candidate));
});

// End call
document.getElementById("end-call").addEventListener("click", () => {
  if (currentCall) {
    socket.emit("call-ended", { to: currentCall, callerId: MY_UID });
    currentCall = null;
    document.getElementById("call-controls").style.display = "none";
    if (pc) pc.close();
  }
});

// Call rejected / ended
socket.on("call-rejected", () => { alert("Call rejected"); resetCall(); });
socket.on("call-ended", () => { alert("Call ended"); resetCall(); });

function resetCall() {
  document.getElementById("call-controls").style.display = "none";
  document.getElementById("incoming-call").style.display = "none";
  if (pc) pc.close();
  pc = null;
  currentCall = null;
}
</script>
</body>
</html>
